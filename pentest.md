# Pentest

- [Ressources](#ressources)
- [tools](#tools)
- [Scan de port](#scan-de-port)
- [Metasploit](#metasploit)
- [Web](#web)
- [SSH](#ssh)
  - [Proxychains](#proxychains)
- [Privilege escalation](#privilege-escalation)
- [Infrastructure](#infrastructure)
- [Reverse shell](#reverse-shell)

## Ressources

Notes utiles :
- https://book.hacktricks.xyz/
- https://pentestmonkey.net/category/cheat-sheet

Shell upgrade : https://d00mfist1.gitbooks.io/ctf/content/spawning_shells.html

Linpeas.sh : https://github.com/carlospolop/PEASS-ng

GTFObins : https://gtfobins.github.io/

Wordlists : https://github.com/danielmiessler/SecLists/

https://github.com/swisskyrepo/PayloadsAllTheThings

https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot

## tools

Cosntructeur de reverse shell : https://www.revshells.com/

https://github.com/AlessandroZ/LaZagne

## Scan de port

```bash
# pinguer tous les hôtes d'un réseau (port 80 + ICMP echo-request)
nmap -vv -T4 -sP 192.168.0.0/24

# scan discret (n'envoi que des TCP SYN, connexion remonte pas à la couche 7, moins de log)
nmap -vv -T4 -sS <ip>

# OS + info sur les services
nmap -vv -T4 -A -oA scan1 <ip>
# scan de vuln
nmap -vv -T4 -sV --script vuln -oA scan1 <ip>
# sur une plage de port
nmap -vv -T4 -sV --script vuln -oA scan1 <ip> -p 0-10000
```

## Metasploit

Catégories de modules (`show [module]` pour les lister) :
1. auxiliary
2. exploits
3. payloads
4. encoders
5. nops
6. post

Pour démarrer :
```bash
msfdb init      # démarrer la db
msfconsole -a   # demande confirmation avant de quitter
```

Commandes :
```bash
# Aide
help|?

# Espaces de travail
workspace           # affiche les workspace
workspace -a <nom>  # create workspace, it becomes current workspace
workspace <nom>     # change workspace
workspace -d <nom>  # delete workspace

# Enregistrement
spool ./msfconsole.log  # tee la session dans un fichier
makerc ./msfconsole.cmd # save all commands since start up to a file
save                    # enregistre les variables dans ~/.msfX/config

# Interactions avec la db
db_status   # check la connexion avec la db
db_import   # importer des résultats de scan par des outils externes
db_nmap     # lance nmap et insert les résultats dans la db
hosts [-R]  # affiche les hôtes ou set RHOSTS directement
services    # affiche les services des hôtes
vulns       # affiche les vulns des services
creds|loot|notes

# Modules
search motif    # filet with type/port/cve/platform
use n           # selectionner le module n
info [n]        # infos sur le module n ou le module courant
options         # affiche les variables du module
advanced        # affiche plus de variables
show missing    # affiche les variables manquantes
check           # certains modules permettent de tester l'exploitabilité
run [-j]        # lancer le module ou le lancer sous forme de job
jobs            # afficher les jobs
sessions [-i n] # afficher les sessions ou s'attacher à la session n
back            # sortir du module

# Variables (insensible à la casse)
set <var> <value>
get <var>
setg <var> <value>  # global
getg <var>
unset <var>
```

Meterpreter :
```bash
# Aide
help|?

bg              # se détacher de la session
migrate <PID>   # migrer le meterpreter vers un autre process
getuid
sysinfo
load kiwi       # charger l'extension de meterpreter mimikatz
getprivs
upload
shell           # ouvrir un shell sur la machine
```

## Web

Détecter les proxy : Méthode `TRACE` (de moins en moins disponible sur les srv web)
Détecter les IPS/WAF : utiliser des mots caractéristiques d'une attaque et voir si page d'erreur (peut permettre d'identifier l'équipement)
Détecter les applications :
- utiliser un dictionnaire sur l'en-tête `Host` de la requête pour trouver des vhosts
- recherche DNS inverse : `dig +short -x <IP>`
- recherche bing/yahoo avec `ip:<IP>`

## SSH

**L**ocal Port Forwarding : ssh host -L 9000:remote_addr:80 puis curl localhost:9000
**R**emote Port Forwarding :
**D**ynamic Port Forwarding : ssh host -D 9000 puis paramétrer un sock proxy dans firefox sur localhost:9000

### Proxychains

Sur la machine locale, editer `/etc/proxychains.conf` :
```
[ProxyList]
socks5 127.0.0.1 9999
...
```

Puis créer le point de sortie avec `ssh root@web -D 9999`.

Plus d'infos sur https://man.cx/proxychains.

## Privilege escalation

Trouver les binaires suid :
```
find / -user root -perm -4000 -exec ls -t {} \; 2>/dev/null
```

systemctl : https://gtfobins.github.io/gtfobins/systemctl/

## Infrastructure

Serveur web :
```bash
python3 -m http.server 8080
```

## Reverse shell

Pour se mettre en écoute :
```bash
# rlwrap permet d'avoir le confort de UP LEFT TAB
rlwrap nc -lnvp 9007
```

[Upgrade de shell](https://d00mfist1.gitbooks.io/ctf/content/spawning_shells.html)
